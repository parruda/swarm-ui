<%= simple_form_for @instance_template, local: true, wrapper: :tailwind, html: { data: { controller: "instance-template-form" } } do |f| %>
  <div class="space-y-6">
    <!-- Basic Information -->
    <div>
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Basic Information</h3>
      
      <%= f.input :name,
                  label: "Template Name",
                  placeholder: "e.g., Frontend Expert",
                  hint: "A descriptive name for your instance template",
                  wrapper: :tailwind %>
      
      <%= f.input :description,
                  as: :text,
                  label: "Description",
                  placeholder: "Describe what this template is for...",
                  hint: "A brief description of the template's purpose and capabilities",
                  wrapper: :tailwind,
                  input_html: { rows: 3 } %>
      
      <%= f.input :category,
                  collection: InstanceTemplate::CATEGORIES,
                  prompt: "Select a category",
                  label: "Category",
                  hint: "Choose the category that best fits this template",
                  wrapper: :tailwind %>
      
      <div class="space-y-2">
        <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Tags</label>
        <input type="text" 
               name="instance_template[tags_string]" 
               value="<%= @instance_template.tags&.join(', ') %>"
               placeholder="e.g., react, typescript, testing (comma-separated)"
               class="block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200">
        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Comma-separated list of tags</p>
      </div>
    </div>

    <!-- Provider Configuration -->
    <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Provider Configuration</h3>
      
      <div class="space-y-2">
        <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Provider</label>
        <%= select_tag "instance_template[config][provider]",
                       options_for_select(InstanceTemplate::PROVIDERS, @instance_template.provider),
                       class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200",
                       data: { 
                         action: "change->instance-template-form#providerChanged",
                         instance_template_form_target: "providerSelect"
                       } %>
      </div>
      
      <div class="space-y-2 mt-4" data-instance-template-form-target="modelField">
        <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Model</label>
        <% if @instance_template.claude? %>
          <%= select_tag "instance_template[config][model]",
                         options_for_select(InstanceTemplate::CLAUDE_MODELS, @instance_template.model),
                         class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200" %>
        <% else %>
          <%= text_field_tag "instance_template[config][model]",
                             @instance_template.model,
                             placeholder: "e.g., gpt-4o, o1, o3-mini",
                             class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200" %>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Common models: gpt-4o, gpt-4o-mini, o1, o1-mini, o3-mini</p>
        <% end %>
      </div>
      
      <!-- OpenAI specific fields -->
      <div class="space-y-4 mt-4 <%= 'hidden' if @instance_template.claude? %>" data-instance-template-form-target="openaiFields">
        <div class="space-y-2">
          <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Temperature</label>
          <%= number_field_tag "instance_template[config][temperature]",
                               @instance_template.temperature,
                               step: 0.1,
                               min: 0,
                               max: 2,
                               placeholder: "0.7",
                               class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200" %>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Value between 0 and 2 (optional)</p>
        </div>
        
        <div class="space-y-2">
          <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">API Version</label>
          <%= select_tag "instance_template[config][api_version]",
                         options_for_select(InstanceTemplate::API_VERSIONS, @instance_template.api_version),
                         include_blank: "Select API version (optional)",
                         class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200" %>
        </div>
        
        <div class="space-y-2">
          <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Reasoning Effort (o-series models only)</label>
          <%= select_tag "instance_template[config][reasoning_effort]",
                         options_for_select(InstanceTemplate::REASONING_EFFORTS, @instance_template.reasoning_effort),
                         include_blank: "Select reasoning effort (optional)",
                         class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200" %>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Only applicable for o1 and o3 series models</p>
        </div>
        
        <div class="space-y-2">
          <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">OpenAI API Key Environment Variable</label>
          <%= text_field_tag "instance_template[config][openai_token_env]",
                             @instance_template.config&.dig("openai_token_env"),
                             placeholder: "OPENAI_API_KEY",
                             class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200" %>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Environment variable name containing the API key (optional)</p>
        </div>
        
        <div class="space-y-2">
          <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Base URL</label>
          <%= text_field_tag "instance_template[config][base_url]",
                             @instance_template.config&.dig("base_url"),
                             placeholder: "https://api.openai.com/v1",
                             class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200" %>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Custom API endpoint (optional)</p>
        </div>
      </div>
    </div>

    <!-- Instance Configuration -->
    <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Instance Configuration</h3>
      
      <div class="space-y-2">
        <label class="text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Working Directory <span class="text-red-500">*</span></label>
        <%= text_field_tag "instance_template[config][directory]",
                           @instance_template.directory,
                           placeholder: ".",
                           required: true,
                           class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200 font-mono" %>
        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Can use variables like ${PROJECT_PATH} or ${CUSTOM_VAR}</p>
      </div>
      
      <%= f.input :system_prompt,
                  as: :text,
                  label: "System Prompt",
                  required: true,
                  placeholder: "Enter the system prompt for this instance...",
                  hint: "Instructions that define the agent's behavior and capabilities",
                  wrapper: :tailwind,
                  input_html: { 
                    rows: 6, 
                    class: "block w-full px-3 py-2 rounded-md border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm focus:outline-none focus:border-orange-500 dark:focus:border-orange-400 focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 sm:text-sm sm:leading-6 transition-colors duration-200 font-mono" 
                  } %>
      
      <div class="flex items-center mt-4" data-instance-template-form-target="vibeField">
        <%= check_box_tag "instance_template[config][vibe]",
                          "1",
                          @instance_template.vibe || @instance_template.openai?,
                          disabled: @instance_template.openai?,
                          class: "h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-600",
                          data: {
                            action: "change->instance-template-form#vibeChanged",
                            instance_template_form_target: "vibeCheckbox"
                          } %>
        <label for="instance_template_config_vibe" class="ml-2 block text-sm text-gray-900 dark:text-gray-100">
          Vibe Mode
          <% if @instance_template.openai? %>
            <span class="text-gray-500">(Always enabled for OpenAI)</span>
          <% end %>
        </label>
      </div>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Enable vibe mode for more creative responses. When enabled, has access to all tools.</p>
      
      <div class="flex items-center mt-4 <%= 'hidden' if @instance_template.openai? %>" data-instance-template-form-target="worktreeField">
        <%= check_box_tag "instance_template[config][worktree]",
                          "1",
                          @instance_template.worktree,
                          class: "h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-600" %>
        <label for="instance_template_config_worktree" class="ml-2 block text-sm text-gray-900 dark:text-gray-100">
          Enable Worktree
        </label>
      </div>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Use git worktree for safer file operations</p>
    </div>

    <!-- Allowed Tools -->
    <div class="pt-6 border-t border-gray-200 dark:border-gray-700 <%= 'hidden' if @instance_template.vibe || @instance_template.openai? %>" data-instance-template-form-target="toolsSection">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Allowed Tools</h3>
          <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Select which tools this instance can use</p>
        </div>
        <div class="flex gap-2">
          <button type="button"
                  data-action="click->instance-template-form#selectAllTools"
                  class="text-xs text-orange-600 hover:text-orange-700 dark:text-orange-400 dark:hover:text-orange-300 font-medium">
            Select All
          </button>
          <span class="text-gray-400 dark:text-gray-600">|</span>
          <button type="button"
                  data-action="click->instance-template-form#clearAllTools"
                  class="text-xs text-orange-600 hover:text-orange-700 dark:text-orange-400 dark:hover:text-orange-300 font-medium">
            Deselect All
          </button>
        </div>
      </div>
      
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-3 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
        <% InstanceTemplate::AVAILABLE_TOOLS.each do |tool| %>
          <label class="flex items-center cursor-pointer hover:text-gray-900 dark:hover:text-gray-100">
            <%= check_box_tag "instance_template[config][allowed_tools][]",
                              tool,
                              @instance_template.allowed_tools&.include?(tool),
                              id: "tool_#{tool}",
                              class: "h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-orange-600 focus:ring-orange-500 cursor-pointer" %>
            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300"><%= tool %></span>
          </label>
        <% end %>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="flex items-center justify-end gap-x-6 pt-6 border-t border-gray-200 dark:border-gray-700">
      <%= link_to "Cancel", instance_templates_path, class: "text-sm font-semibold leading-6 text-gray-900 dark:text-gray-100 hover:text-gray-700 dark:hover:text-gray-300 transition-colors duration-200" %>
      <%= f.submit @instance_template.persisted? ? "Update Template" : "Create Template", class: "rounded-md bg-orange-600 dark:bg-orange-900 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-orange-500 dark:hover:bg-orange-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600 dark:focus-visible:outline-orange-900 transition-colors duration-200" %>
    </div>
  </div>
<% end %>