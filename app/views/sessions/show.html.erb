<div class="h-screen flex flex-col bg-gray-900">
  <%# Session Header %>
  <div class="flex-shrink-0 p-4 bg-gray-800 text-white flex justify-between items-center">
    <div>
      <h1 class="text-xl">Claude Swarm - <%= @session.swarm_name || "Unnamed" %></h1>
      <p class="text-sm text-gray-400">
        Session: <%= @session.session_id %> | Mode: <%= @session.mode.humanize %>
      </p>
    </div>
    <div class="flex gap-2">
      <%= link_to "Close window", root_path, 
          class: "px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 text-sm" %>
      <%= link_to "View Logs", logs_session_path(@session.session_id), 
          class: "px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 text-sm" %>
      <%= button_to "Stop Session", session_path(@session.session_id), 
          method: :delete,
          data: { confirm: "Are you sure you want to stop this session?" },
          class: "px-4 py-2 bg-red-600 rounded hover:bg-red-700 text-sm cursor-pointer" %>
    </div>
  </div>
  
  <%# Main Content Area - Split Layout %>
  <div class="flex-1 flex gap-4 p-4 overflow-hidden" data-controller="session-sidebar">
    <%# Terminal Section %>
    <div class="flex-1 min-h-0">
      <% if @session.tmux_session.present? %>
        <%# Check if tmux session actually exists %>
        <% tmux_exists = system("tmux", "has-session", "-t", @session.tmux_session, err: File::NULL, out: File::NULL) %>
        
        <% if tmux_exists %>
          <%# Tmux session exists, show the terminal %>
          <iframe 
            src="http://127.0.0.1:8999/?arg=<%= @session.tmux_session %>"
            class="w-full h-full bg-black rounded"
            style="overflow: hidden; scrollbar-width: none; -ms-overflow-style: none;"
            scrolling="no"
            title="Terminal for <%= @session.swarm_name %>"
            allow="fullscreen">
          </iframe>
        <% else %>
          <%# Tmux session doesn't exist, show appropriate message based on status %>
          <div class="h-full bg-black rounded flex items-center justify-center">
            <div class="text-center">
              <% if @session.status == 'terminated' %>
                <p class="text-gray-400 mb-4">Session has been terminated.</p>
              <% else %>
                <p class="text-gray-400 mb-4">Session not running. Click the button below to start it.</p>
                <%# Show a button to launch the session %>
                <% # For inactive sessions or sessions with metadata, pass --session-id to restore/resume %>
                <% # For new active sessions without metadata, let claude-swarm generate its own ID %>
                <% should_pass_session_id = @session.status == 'inactive' || (@session.session_path && File.exist?(File.join(@session.session_path, "session_metadata.json"))) %>
                <iframe 
                  src="http://127.0.0.1:8999/?arg=<%= @session.tmux_session %>&arg=-c&arg=<%= @session.working_directory %>&arg=bundle&arg=exec&arg=claude-swarm&arg=start&arg=<%= @session.session_path %>/config.yml<%= should_pass_session_id ? "&arg=--session-id&arg=#{@session.session_id}" : "" %><%= @session.worktree_path.present? ? "&arg=--worktree" : "" %>"
                  class="w-full h-full"
                  style="overflow: hidden; scrollbar-width: none; -ms-overflow-style: none;"
                  scrolling="no"
                  title="Launch terminal for <%= @session.swarm_name %>"
                  allow="fullscreen">
                </iframe>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="h-full bg-black rounded flex items-center justify-center">
          <p class="text-gray-400">Session not configured. Please check session settings.</p>
        </div>
      <% end %>
    </div>
    
    <%# Session Info Panel - Right Side %>
    <div class="w-80 bg-gray-800 rounded-lg text-white overflow-y-auto transition-all duration-300 hidden" data-session-sidebar-target="panel">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <h2 class="text-lg font-semibold">Session Details</h2>
        <button 
          class="bg-gray-700 hover:bg-gray-600 text-white p-1.5 rounded transition-colors"
          data-action="click->session-sidebar#toggle"
          data-session-sidebar-target="toggleButton"
          title="Hide session details">
          <%= heroicon "chevron-right", variant: :solid, options: { class: "h-4 w-4" } %>
        </button>
      </div>
      
      <div class="p-4 space-y-4">
        
        <%# Status and Cost %>
        <div class="space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">Status:</span>
            <span>
              <% if @active %>
                <span class="text-green-400">● Active</span>
              <% else %>
                <span class="text-gray-500">○ Inactive</span>
              <% end %>
            </span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">Total Cost:</span>
            <span>$<%= "%.4f" % (@total_cost || 0) %></span>
          </div>
        </div>
        
        <%# Divider %>
        <div class="border-t border-gray-700"></div>
        
        <%# Instance Hierarchy %>
        <% if @instance_hierarchy.present? %>
          <div>
            <h3 class="text-sm font-medium text-gray-300 mb-3">Instances</h3>
            <div class="space-y-2">
              <% @instance_hierarchy.each do |name, info| %>
                <div class="flex justify-between text-sm bg-gray-700/50 rounded p-2">
                  <span class="flex items-center gap-2">
                    <%= name %>
                    <% if info[:is_main] %>
                      <span class="text-xs bg-blue-600 px-1.5 py-0.5 rounded">main</span>
                    <% end %>
                  </span>
                  <span class="text-gray-400">$<%= "%.4f" % (info[:costs] || 0) %></span>
                </div>
              <% end %>
            </div>
          </div>
          
          <%# Divider %>
          <div class="border-t border-gray-700"></div>
        <% end %>
        
        <%# Working Directory %>
        <div>
          <h3 class="text-sm font-medium text-gray-300 mb-2">Working Directory</h3>
          <code class="text-xs bg-gray-700 px-2 py-1 rounded block break-all"><%= @session.working_directory %></code>
        </div>
        
        <%# Session Path %>
        <div>
          <h3 class="text-sm font-medium text-gray-300 mb-2">Session Path</h3>
          <code class="text-xs bg-gray-700 px-2 py-1 rounded block break-all"><%= @session.session_path %></code>
        </div>
        
        <%# Session Metadata %>
        <div class="pt-4 border-t border-gray-700">
          <div class="space-y-2 text-xs text-gray-400">
            <div class="flex justify-between">
              <span>Created:</span>
              <span><%= @session.created_at.strftime("%Y-%m-%d %H:%M") %></span>
            </div>
            <% if @session.launched_at %>
              <div class="flex justify-between">
                <span>Launched:</span>
                <span><%= @session.launched_at.strftime("%Y-%m-%d %H:%M") %></span>
              </div>
            <% end %>
            <div class="flex justify-between">
              <span>Session ID:</span>
              <span class="font-mono"><%= @session.session_id %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <%# Floating button to show panel when hidden %>
    <button 
      class="fixed right-4 top-1/2 -translate-y-1/2 bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-l-lg shadow-lg transition-colors"
      data-action="click->session-sidebar#toggle"
      data-session-sidebar-target="showButton"
      title="Show session details">
      <%= heroicon "chevron-left", variant: :solid, options: { class: "h-5 w-5" } %>
    </button>
  </div>
</div>