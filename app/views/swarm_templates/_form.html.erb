<div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
  <!-- Left panel - Configuration Form -->
  <div class="lg:col-span-2">
    <div class="bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-900/5 dark:ring-gray-700 sm:rounded-xl">
      <div class="px-4 py-6 sm:p-8">
        <%= simple_form_for swarm_template.project ? [swarm_template.project, swarm_template] : swarm_template, local: true, wrapper: :tailwind do |f| %>
          <div class="space-y-6">
            <!-- Basic Information -->
            <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
              <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100">Basic Information</h3>
              
              <div class="mt-4 space-y-4">
                <%= f.input :name, 
                            label: "Template Name", 
                            placeholder: "My Swarm Template",
                            hint: "A descriptive name for your swarm configuration",
                            wrapper: :tailwind %>
                
                <%= f.input :description,
                            as: :text,
                            label: "Description",
                            placeholder: "Describe what this swarm is for...",
                            hint: "Explain the purpose and capabilities of this swarm",
                            wrapper: :tailwind,
                            input_html: { rows: 3 } %>
              </div>
            </div>

            <!-- Instance Builder -->
            <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100">Instances</h3>
                <button type="button"
                        data-action="click->swarm-builder#openInstancePicker"
                        class="inline-flex items-center rounded-md bg-orange-600 dark:bg-orange-900 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-orange-500 dark:hover:bg-orange-800 transition-colors duration-200">
                  <%= heroicon "plus", variant: :mini, options: { class: "h-4 w-4 mr-1.5" } %>
                  Add Instance
                </button>
              </div>
              
              <!-- Instance Cards Container -->
              <div data-swarm-builder-target="instancesContainer" class="space-y-4">
                <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                  <%= heroicon "cube", variant: :outline, options: { class: "h-12 w-12 mx-auto mb-3" } %>
                  <p>No instances added yet. Click "Add Instance" to begin.</p>
                </div>
              </div>
              
              <!-- Hidden fields for config_data -->
              <%= f.hidden_field :config_data, data: { swarm_builder_target: "configData" }, value: swarm_template.config_data.to_json %>
            </div>

            <!-- Submit buttons -->
            <div class="flex items-center justify-end gap-x-6">
              <%= link_to "Cancel", swarm_template.persisted? ? swarm_template : (swarm_template.project || root_path), 
                          class: "text-sm font-semibold leading-6 text-gray-900 dark:text-gray-100 hover:text-gray-700 dark:hover:text-gray-300 transition-colors duration-200" %>
              <%= f.submit swarm_template.persisted? ? "Update Swarm Template" : "Create Swarm Template", 
                           class: "rounded-md bg-orange-600 dark:bg-orange-900 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-orange-500 dark:hover:bg-orange-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600 dark:focus-visible:outline-orange-900 transition-colors duration-200" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Right panel - YAML Preview -->
  <div class="lg:col-span-1">
    <div class="sticky top-4 bg-white dark:bg-gray-800 shadow-sm ring-1 ring-gray-900/5 dark:ring-gray-700 sm:rounded-xl">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100 mb-4">YAML Preview</h3>
        
        <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 font-mono text-xs overflow-x-auto max-h-[600px] overflow-y-auto">
          <pre data-swarm-builder-target="yamlPreview" class="text-gray-700 dark:text-gray-300"><%= swarm_template.persisted? ? swarm_template.to_yaml : "version: 1\nswarm:\n  name: \"\"\n  instances: {}" %></pre>
        </div>
        
        <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
          <p>This preview updates automatically as you configure your swarm.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Instance Picker Modal -->
<div data-swarm-builder-target="instancePickerModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex min-h-screen items-end justify-center px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" data-action="click->swarm-builder#closeInstancePicker"></div>

    <span class="hidden sm:inline-block sm:h-screen sm:align-middle">&#8203;</span>

    <div class="relative inline-block transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pt-5 pb-4 text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-3xl sm:p-6 sm:align-middle">
      <div class="absolute top-0 right-0 pt-4 pr-4">
        <button type="button" 
                data-action="click->swarm-builder#closeInstancePicker"
                class="rounded-md bg-white dark:bg-gray-800 text-gray-400 hover:text-gray-500 focus:outline-none">
          <span class="sr-only">Close</span>
          <%= heroicon "x-mark", variant: :outline, options: { class: "h-6 w-6" } %>
        </button>
      </div>
      
      <div>
        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-gray-100">Add Instance</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Choose from existing templates or create a custom instance.</p>
      </div>

      <div class="mt-6">
        <!-- Tab navigation -->
        <div class="border-b border-gray-200 dark:border-gray-700">
          <nav class="-mb-px flex space-x-8">
            <button type="button"
                    data-action="click->swarm-builder#switchTab"
                    data-tab="templates"
                    class="whitespace-nowrap border-b-2 border-orange-500 py-2 px-1 text-sm font-medium text-orange-600 dark:text-orange-400">
              Instance Templates
            </button>
            <button type="button"
                    data-action="click->swarm-builder#switchTab"
                    data-tab="custom"
                    class="whitespace-nowrap border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700 dark:text-gray-400 dark:hover:border-gray-600 dark:hover:text-gray-300">
              Custom Instance
            </button>
          </nav>
        </div>

        <!-- Tab content -->
        <div class="mt-6">
          <!-- Templates tab -->
          <div data-swarm-builder-target="templatesTab">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
              <% @instance_templates.each do |template| %>
                <div class="relative rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-4 shadow-sm hover:border-gray-400 dark:hover:border-gray-500 cursor-pointer"
                     data-action="click->swarm-builder#selectInstanceTemplate"
                     data-template-id="<%= template.id %>"
                     data-template-name="<%= template.name %>"
                     data-template-config="<%= template.config.to_json %>">
                  <div>
                    <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= template.name %></h4>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400"><%= template.description %></p>
                    <div class="mt-2 flex items-center gap-2">
                      <span class="inline-flex items-center rounded-full bg-blue-100 dark:bg-blue-900 px-2.5 py-0.5 text-xs font-medium text-blue-800 dark:text-blue-200">
                        <%= template.model %>
                      </span>
                      <% if template.system_template? %>
                        <span class="inline-flex items-center rounded-full bg-blue-100 dark:bg-blue-900 px-2.5 py-0.5 text-xs font-medium text-blue-800 dark:text-blue-200">
                          System
                        </span>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Custom instance tab -->
          <div data-swarm-builder-target="customTab" class="hidden">
            <form data-swarm-builder-target="customInstanceForm" class="space-y-4">
              <div>
                <label for="instance_key" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Instance Key</label>
                <input type="text" 
                       name="instance_key" 
                       id="instance_key"
                       placeholder="frontend_expert"
                       pattern="[a-z_]+"
                       required
                       class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 py-2 px-3 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:border-orange-500 focus:ring-orange-500 dark:focus:ring-orange-500 sm:text-sm sm:leading-6 transition-colors duration-200">
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Lowercase letters and underscores only</p>
              </div>
              
              <div>  
                <label for="description" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Description <span class="text-red-500">*</span></label>
                <input type="text" 
                       name="description" 
                       id="description"
                       placeholder="Frontend development expert"
                       required
                       class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 py-2 px-3 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:border-orange-500 focus:ring-orange-500 dark:focus:ring-orange-500 sm:text-sm sm:leading-6 transition-colors duration-200">
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="provider" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Provider</label>
                  <select name="provider" 
                          id="provider"
                          class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 py-2 px-3 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 focus:border-orange-500 focus:ring-orange-500 dark:focus:ring-orange-500 sm:text-sm sm:leading-6 transition-colors duration-200">
                    <option value="claude">Claude</option>
                    <option value="openai">OpenAI</option>
                  </select>
                </div>
                
                <div>
                  <label for="model" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Model <span class="text-red-500">*</span></label>
                  <input type="text" 
                         name="model" 
                         id="model"
                         placeholder="sonnet, opus, gpt-4o, etc."
                         required
                         class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 py-2 px-3 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:border-orange-500 focus:ring-orange-500 dark:focus:ring-orange-500 sm:text-sm sm:leading-6 transition-colors duration-200">
                  <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">e.g., sonnet, opus, gpt-4o, o3</p>
                </div>
              </div>
              
              <div>
                <label for="directory" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-100">Directory</label>
                <input type="text" 
                       name="directory" 
                       id="directory"
                       value="."
                       placeholder=". or ${PROJECT_DIR}"
                       class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 py-2 px-3 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:border-orange-500 focus:ring-orange-500 dark:focus:ring-orange-500 sm:text-sm sm:leading-6 transition-colors duration-200">
                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Use . for current directory or environment variables like ${PROJECT_DIR}</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-100 mb-3">Allowed Tools</label>
                <div class="space-y-3 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                  <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    <% InstanceTemplate::AVAILABLE_TOOLS.each do |tool| %>
                      <label class="flex items-center cursor-pointer hover:text-gray-900 dark:hover:text-gray-100">
                        <input type="checkbox" 
                               name="allowed_tools[]" 
                               value="<%= tool %>"
                               <%= tool.in?(['Read', 'Edit', 'Write', 'Bash']) ? 'checked' : '' %>
                               class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-orange-600 focus:ring-orange-500 cursor-pointer">
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300"><%= tool %></span>
                      </label>
                    <% end %>
                  </div>
                </div>
              </div>
              
              <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button"
                        data-action="click->swarm-builder#closeInstancePicker"
                        class="inline-flex items-center rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-100 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200">
                  Cancel
                </button>
                <button type="submit"
                        data-action="click->swarm-builder#addCustomInstance"
                        class="inline-flex items-center rounded-md bg-orange-600 dark:bg-orange-900 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-orange-500 dark:hover:bg-orange-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600 dark:focus-visible:outline-orange-900 transition-colors duration-200">
                  Add Instance
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>