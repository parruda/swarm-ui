<% content_for :title, "Swarm Builder" %>
<%# Version: Time.current.to_i %>

<% content_for :full_width do %>
<div class="fixed inset-0 top-[56px] flex flex-col bg-gray-50 dark:bg-gray-900" 
     data-controller="swarm-visual-builder"
     data-swarm-visual-builder-swarm-id-value="<%= @swarm_template.persisted? ? @swarm_template.id : '' %>"
     data-swarm-visual-builder-existing-data-value='<%= @swarm_template.visual_data&.to_json || "{}" %>'
     data-swarm-visual-builder-existing-yaml-value='<%= @swarm_template.yaml_content || "" %>'
     data-swarm-visual-builder-project-id-value="<%= @swarm_template.visual_data&.dig('project_id') || @project&.id || '' %>"
     data-swarm-visual-builder-project-name-value="<%= @swarm_template.visual_data&.dig('project_name') || @project&.name || '' %>"
     data-swarm-visual-builder-project-path-value="<%= @swarm_template.visual_data&.dig('project_path') || @project&.path || '' %>"
     data-swarm-visual-builder-is-file-edit-value="<%= @swarm_template.visual_data&.dig('is_file_edit') || false %>"
     data-swarm-visual-builder-is-new-file-value="<%= @swarm_template.visual_data&.dig('is_new_file') || false %>"
     data-swarm-visual-builder-file-path-value="<%= @swarm_template.visual_data&.dig('file_path') || '' %>">
  <!-- Header -->
  <div class="bg-white dark:bg-gray-800 shadow-md border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
    <div class="px-6 py-5">
      <div class="flex items-center justify-between gap-6">
        <!-- Left section -->
        <div class="flex items-center gap-5 flex-shrink-0">
          <% back_path = if @swarm_template.visual_data&.dig('is_file_edit') || @swarm_template.visual_data&.dig('is_new_file')
               project_path(@swarm_template.visual_data['project_id'] || @project)
             else
               swarm_templates_path
             end %>
          <%= link_to back_path, class: "p-2 -m-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" do %>
            <%= heroicon "arrow-left", variant: :outline, options: { class: "h-5 w-5" } %>
          <% end %>
          <div class="flex items-center gap-3">
            <div class="w-px h-8 bg-gray-300 dark:bg-gray-600"></div>
            <div>
              <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Swarm Builder</h1>
              <% if @swarm_template.visual_data&.dig('project_name') %>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                  <% if @swarm_template.visual_data&.dig('is_file_edit') %>
                    Editing: <%= File.basename(@swarm_template.visual_data['file_path']) %>
                  <% elsif @swarm_template.visual_data&.dig('is_new_file') %>
                    Creating new swarm for: <%= @swarm_template.visual_data['project_name'] %>
                  <% else %>
                    Project: <%= @swarm_template.visual_data['project_name'] %>
                  <% end %>
                </p>
              <% end %>
            </div>
          </div>
        </div>
        
        <!-- Center section - now empty as fields moved to canvas -->
        <div class="flex-1"></div>
        
        <!-- Right section -->
        <div class="flex items-center gap-3 flex-shrink-0">
          <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-900 rounded-lg p-1">
            <!-- Import Dropdown -->
            <div class="relative inline-block text-left" data-controller="dropdown">
              <button type="button"
                      data-action="click->dropdown#toggle"
                      data-dropdown-target="button"
                      class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm transition-all hover:shadow-md">
                <%= heroicon "arrow-down-tray", variant: :outline, options: { class: "h-4 w-4 mr-2" } %>
                Import
                <%= heroicon "chevron-down", variant: :mini, options: { class: "h-4 w-4 ml-1 -mr-1" } %>
              </button>
              
              <div data-dropdown-target="menu"
                   class="hidden absolute right-0 z-50 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5 dark:ring-gray-700 focus:outline-none">
                <div class="py-1" role="none">
                  <button type="button"
                          data-action="click->dropdown#hide click->swarm-visual-builder#importYaml"
                          class="group flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <%= heroicon "folder-open", variant: :outline, options: { class: "h-5 w-5 mr-3 text-gray-400 dark:text-gray-500 group-hover:text-gray-500 dark:group-hover:text-gray-400" } %>
                    From File
                  </button>
                  
                  <button type="button"
                          data-action="click->dropdown#hide click->swarm-visual-builder#openPasteYamlModal"
                          class="group flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <%= heroicon "clipboard-document", variant: :outline, options: { class: "h-5 w-5 mr-3 text-gray-400 dark:text-gray-500 group-hover:text-gray-500 dark:group-hover:text-gray-400" } %>
                    Paste YAML
                  </button>
                </div>
              </div>
            </div>
            
            <button type="button"
                    data-action="click->swarm-visual-builder#exportYaml"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm transition-all hover:shadow-md">
              <%= heroicon "arrow-up-tray", variant: :outline, options: { class: "h-4 w-4 mr-2" } %>
              Export
            </button>
          </div>
          
          <button type="button"
                  id="save-swarm"
                  data-action="click->swarm-visual-builder#saveSwarm"
                  class="inline-flex items-center px-5 py-2.5 text-sm font-semibold text-white bg-green-800 dark:bg-green-800 rounded-lg hover:bg-green-700 dark:hover:bg-green-700 shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200">
            <%= heroicon "check-circle", variant: :solid, options: { class: "h-5 w-5 mr-2" } %>
            <% if @swarm_template.visual_data&.dig('is_file_edit') %>
              Save to File
            <% elsif @swarm_template.visual_data&.dig('is_new_file') %>
              Save as File
            <% elsif @swarm_template.persisted? %>
              Update Swarm
            <% else %>
              Save Swarm
            <% end %>
          </button>
          
          <button type="button"
                  id="launch-swarm"
                  data-action="click->swarm-visual-builder#launchSwarm"
                  <%= (@swarm_template.visual_data&.dig('is_file_edit') || @swarm_template.persisted?) ? '' : 'disabled' %>
                  class="inline-flex items-center px-5 py-2.5 text-sm font-semibold text-white bg-orange-900 dark:bg-orange-900 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 <%= (@swarm_template.visual_data&.dig('is_file_edit') || @swarm_template.persisted?) ? 'hover:bg-orange-800 dark:hover:bg-orange-800' : 'opacity-50 cursor-not-allowed' %>">
            <%= heroicon "play", variant: :solid, options: { class: "h-5 w-5 mr-2" } %>
            Launch
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="flex-1 flex min-h-0">
    <!-- Left Panel - Instance Library with Tabs -->
    <div class="w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col flex-shrink-0">
      <!-- Tabs -->
      <div class="border-b border-gray-200 dark:border-gray-700">
        <nav class="flex">
          <button type="button"
                  data-swarm-visual-builder-target="instancesTabButton"
                  data-action="click->swarm-visual-builder#switchToInstancesTab"
                  class="flex-1 px-4 py-3 text-sm font-medium text-orange-600 dark:text-orange-400 border-b-2 border-orange-600 dark:border-orange-400 cursor-pointer transition-colors">
            Instances
          </button>
          <button type="button"
                  data-swarm-visual-builder-target="mcpServersTabButton"
                  data-action="click->swarm-visual-builder#switchToMcpServersTab"
                  class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent cursor-pointer transition-colors">
            MCP Servers
          </button>
        </nav>
      </div>
      
      <!-- Tab Content -->
      <div class="flex-1 overflow-y-auto">
        <!-- Instances Tab -->
        <div data-swarm-visual-builder-target="instancesTab" class="p-4">
          <button type="button"
                  data-action="click->swarm-visual-builder#addBlankInstance"
                  class="w-full px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
            <%= heroicon "plus", variant: :outline, options: { class: "h-4 w-4 inline mr-2" } %>
            Add Blank Instance
          </button>
          
          <div class="my-4 border-t border-gray-200 dark:border-gray-700"></div>
          
          <div class="mb-4">
            <input type="text"
                   data-swarm-visual-builder-target="searchInput"
                   data-action="input->swarm-visual-builder#filterTemplates"
                   placeholder="Search instances..."
                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
          </div>
          
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
            Instance Templates
          </h3>
          
          <div data-swarm-visual-builder-target="instanceTemplates" class="space-y-2">
            <% @instance_templates.each do |template| %>
              <div draggable="true"
                   data-template-card
                   data-template-id="<%= template.id %>"
                   data-template-name="<%= template.name %>"
                   data-template-description="<%= template.description %>"
                   data-template-config='<%= template.config.merge("system_prompt" => template.system_prompt).to_json %>'
                   class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-move hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                <div class="flex items-start justify-between">
                  <div>
                    <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= template.name %></h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"><%= template.description %></p>
                  </div>
                  <span class="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded">
                    <%= template.model %>
                  </span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        
        <!-- MCP Servers Tab -->
        <div data-swarm-visual-builder-target="mcpServersTab" class="p-4 hidden">
          <div class="mb-4">
            <input type="text"
                   data-swarm-visual-builder-target="mcpSearchInput"
                   data-action="input->swarm-visual-builder#filterMcpServers"
                   placeholder="Search MCP servers..."
                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
          </div>
          
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">
            Available MCP Servers
          </h3>
          
          <div data-swarm-visual-builder-target="mcpServersList" class="space-y-2">
            <% McpServer.ordered.each do |mcp_server| %>
              <div draggable="true"
                   data-mcp-card
                   data-mcp-id="<%= mcp_server.id %>"
                   data-mcp-name="<%= mcp_server.name %>"
                   data-mcp-type="<%= mcp_server.server_type %>"
                   data-mcp-config='<%= mcp_server.to_mcp_config.to_json %>'
                   class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-move hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors group">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= mcp_server.name %></h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"><%= mcp_server.description %></p>
                    <div class="flex items-center gap-2 mt-2">
                      <span class="text-xs px-2 py-0.5 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded">
                        <%= mcp_server.server_type.upcase %>
                      </span>
                      <% if mcp_server.tags.present? %>
                        <% mcp_server.tags.first(2).each do |tag| %>
                          <span class="text-xs px-2 py-0.5 bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 rounded">
                            <%= tag %>
                          </span>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                  <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                    <%= heroicon "server", variant: :outline, options: { class: "h-4 w-4 text-gray-400" } %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Center - Visual Canvas -->
    <div class="flex-1 relative min-w-0">
      <div data-swarm-visual-builder-target="canvas" 
           class="absolute inset-0 bg-gray-100 dark:bg-gray-900 overflow-auto">
        <!-- Canvas content will be inserted here -->
        
        <!-- Empty state -->
        <div data-swarm-visual-builder-target="emptyState" 
             class="absolute inset-0 flex items-center justify-center">
          <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 2l10 5v10l-10 5-10-5V7z M12 7v10 M2 7l10 5 10-5 M7 19.5V9.5l10 5v10" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">No instances yet</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Drag instance templates from the left panel to get started</p>
          </div>
        </div>
      </div>
      
      <!-- Zoom controls -->
      <div class="absolute bottom-4 left-4 flex items-center space-x-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2">
        <button type="button" 
                data-action="click->swarm-visual-builder#zoomOut"
                class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
          <%= heroicon "minus", variant: :solid, options: { class: "h-4 w-4" } %>
        </button>
        <span class="text-sm px-2" data-swarm-visual-builder-target="zoomLevel">100%</span>
        <button type="button" 
                data-action="click->swarm-visual-builder#zoomIn"
                class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
          <%= heroicon "plus", variant: :solid, options: { class: "h-4 w-4" } %>
        </button>
      </div>
      
      <!-- Canvas toolbar -->
      <div class="absolute top-4 left-4 flex items-center space-x-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2">
        <button type="button" 
                title="Auto-layout" 
                data-action="click->swarm-visual-builder#autoLayout"
                class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
          <%= heroicon "squares-plus", variant: :outline, options: { class: "h-4 w-4" } %>
        </button>
        <div class="w-px h-6 bg-gray-300 dark:bg-gray-600"></div>
        <button type="button" 
                title="Clear all" 
                data-action="click->swarm-visual-builder#clearAll"
                class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-red-600">
          <%= heroicon "trash", variant: :outline, options: { class: "h-4 w-4" } %>
        </button>
      </div>
      
      <!-- Floating form fields - top right -->
      <div class="absolute top-4 right-4 flex items-center gap-3" style="z-index: 10;">
        <!-- Swarm Name -->
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <%= heroicon "beaker", variant: :outline, options: { class: "h-5 w-5 text-gray-400" } %>
          </div>
          <input type="text"
                 id="swarm_template_name"
                 data-swarm-visual-builder-target="nameInput"
                 data-action="input->swarm-visual-builder#updateYamlPreview"
                 placeholder="Enter swarm name..."
                 class="w-64 pl-10 pr-4 py-2.5 text-sm font-medium border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:border-orange-500 dark:focus:border-orange-400 focus:outline-none focus:ring-4 focus:ring-orange-500/20 dark:focus:ring-orange-400/20 transition-all shadow-lg">
        </div>
        
        <!-- Tags -->
        <div class="flex items-center gap-2 bg-white dark:bg-gray-800 rounded-lg px-4 py-2.5 border-2 border-gray-300 dark:border-gray-600 shadow-lg">
          <%= heroicon "tag", variant: :outline, options: { class: "h-5 w-5 text-gray-500 dark:text-gray-400 flex-shrink-0" } %>
          <input type="text"
                 data-swarm-visual-builder-target="tagInput"
                 data-action="keydown->swarm-visual-builder#addTag"
                 placeholder="Add tags..."
                 class="w-48 bg-transparent border-0 outline-none text-sm text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 px-0 py-0">
          <div data-swarm-visual-builder-target="tagsContainer" class="flex items-center gap-2 flex-wrap flex-1 min-h-[20px]"></div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Properties/YAML -->
    <div class="bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex flex-col flex-shrink-0 relative" 
         data-swarm-visual-builder-target="rightSidebar"
         style="width: 384px; min-width: 300px; max-width: 800px;">
      <!-- Resize Handle -->
      <div class="absolute left-0 top-0 bottom-0 w-2 -ml-1 cursor-ew-resize group"
           data-swarm-visual-builder-target="resizeHandle"
           data-action="mousedown->swarm-visual-builder#startResize">
        <div class="absolute left-1/2 top-0 bottom-0 w-0.5 -ml-px bg-gray-300 dark:bg-gray-600 group-hover:bg-orange-500 dark:group-hover:bg-orange-400 transition-colors"></div>
        <!-- Floating grip handle -->
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
          <div class="bg-white dark:bg-gray-700 rounded-md shadow-lg border border-gray-300 dark:border-gray-600 px-1 py-3">
            <svg class="w-3 h-6 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 12 24">
              <circle cx="3" cy="4" r="1.5"/>
              <circle cx="9" cy="4" r="1.5"/>
              <circle cx="3" cy="12" r="1.5"/>
              <circle cx="9" cy="12" r="1.5"/>
              <circle cx="3" cy="20" r="1.5"/>
              <circle cx="9" cy="20" r="1.5"/>
            </svg>
          </div>
        </div>
      </div>
      <!-- Tabs -->
      <div class="border-b border-gray-200 dark:border-gray-700">
        <nav class="flex">
          <button type="button" 
                  data-swarm-visual-builder-target="propertiesTabButton"
                  data-action="click->swarm-visual-builder#switchToProperties"
                  class="flex-1 px-4 py-3 text-sm font-medium text-orange-600 dark:text-orange-400 border-b-2 border-orange-600 dark:border-orange-400">
            Properties
          </button>
          <button type="button" 
                  data-swarm-visual-builder-target="yamlTabButton"
                  data-action="click->swarm-visual-builder#switchToYaml"
                  class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent">
            YAML Preview
          </button>
          <button type="button" 
                  data-swarm-visual-builder-target="chatTabButton"
                  data-action="click->swarm-visual-builder#switchToChat"
                  class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent">
            💬 Chat
          </button>
        </nav>
      </div>
      
      <!-- Tab Panels -->
      <div class="flex-1 overflow-hidden">
        <!-- Properties Panel -->
        <div data-swarm-visual-builder-target="propertiesTab" class="h-full overflow-y-auto">
          <div data-swarm-visual-builder-target="propertiesPanel" class="h-full">
            <div class="p-4 text-center text-gray-500 dark:text-gray-400">
              <p>Select an instance to edit its properties</p>
            </div>
          </div>
        </div>
        
        <!-- YAML Preview -->
        <div data-swarm-visual-builder-target="yamlPreviewTab" 
             class="hidden h-full flex flex-col">
          <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-end">
            <button type="button"
                    data-action="click->swarm-visual-builder#copyYaml"
                    class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <%= heroicon "clipboard-document", variant: :outline, options: { class: "h-4 w-4 mr-1.5" } %>
              Copy YAML
            </button>
          </div>
          <div data-swarm-visual-builder-target="yamlPreview" 
               class="flex-1 overflow-y-auto p-4 bg-gray-50 dark:bg-gray-900">
            <pre class="text-sm font-mono text-gray-700 dark:text-gray-300"></pre>
          </div>
        </div>
        
        <% @conversation_id = SecureRandom.uuid %>
        <!-- Chat Panel -->
        <div data-swarm-visual-builder-target="chatTab" 
             class="hidden h-full flex flex-col"
             data-controller="claude-chat"
             data-claude-chat-project-id-value="<%= @swarm_template.visual_data&.dig('project_id') || @project&.id || '' %>"
             data-claude-chat-file-path-value="<%= @swarm_template.visual_data&.dig('file_path') || '' %>"
             data-claude-chat-conversation-id-value="<%= @conversation_id %>">
          
          <!-- Chat header with status -->
          <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <%= heroicon "sparkles", variant: :solid, options: { class: "h-5 w-5 text-orange-500" } %>
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">AI Assistant</span>
            </div>
            <div data-claude-chat-target="status" class="text-xs text-gray-500 dark:text-gray-400">
              <% if @swarm_template.visual_data&.dig('file_path').present? %>
                Ready
              <% else %>
                Save file to enable chat
              <% end %>
            </div>
          </div>
          
          <!-- Turbo Stream subscription for chat messages -->
          <% if @swarm_template.visual_data&.dig('file_path').present? %>
            <%= turbo_stream_from "claude_chat_#{@swarm_template.visual_data['project_id']}_#{@conversation_id}" %>
          <% end %>
          
          <!-- Chat messages area -->
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div id="chat_messages" data-claude-chat-target="messages">
              <% if @swarm_template.visual_data&.dig('file_path').blank? %>
                <div class="text-center py-8">
                  <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 dark:bg-yellow-900">
                    <%= heroicon "exclamation-triangle", variant: :outline, options: { class: "h-6 w-6 text-yellow-600 dark:text-yellow-400" } %>
                  </div>
                  <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">File Not Saved</h3>
                  <p class="mt-1 text-sm text-gray-500 dark:text-gray-400 max-w-xs mx-auto">
                    Please save your swarm to a file first to enable AI assistance.
                  </p>
                </div>
              <% else %>
                <div id="welcome_message" class="text-center py-8">
                  <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gradient-to-br from-orange-400 to-orange-600">
                    <%= heroicon "chat-bubble-left-right", variant: :solid, options: { class: "h-6 w-6 text-white" } %>
                  </div>
                  <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">Start a Conversation</h3>
                  <p class="mt-1 text-sm text-gray-500 dark:text-gray-400 max-w-xs mx-auto">
                    Ask me to help you build your swarm configuration. I can add instances, configure connections, and explain best practices.
                  </p>
                </div>
              <% end %>
            </div>
          </div>
          
          <!-- Chat input area -->
          <div class="border-t border-gray-200 dark:border-gray-700 p-4">
            <%= form_with url: api_claude_chat_path, 
                          method: :post,
                          data: { 
                            controller: "claude-chat-form",
                            action: "submit->claude-chat-form#submit",
                            claude_chat_target: "form"
                          },
                          class: "flex gap-2" do |f| %>
              <%= f.hidden_field :project_id, value: @swarm_template.visual_data&.dig('project_id') || @project&.id %>
              <%= f.hidden_field :file_path, value: @swarm_template.visual_data&.dig('file_path') %>
              <%= f.hidden_field :tracking_id, value: @conversation_id, data: { claude_chat_target: "trackingIdField" } %>
              <%= f.hidden_field :session_id, value: "", data: { claude_chat_target: "sessionIdField" } %>
              
              <%= f.text_area :prompt,
                              data: { 
                                claude_chat_target: "input",
                                action: "keydown->claude-chat#handleKeydown"
                              },
                              placeholder: @swarm_template.visual_data&.dig('file_path').present? ? 
                                          'Ask Claude to help build your swarm...' : 
                                          'Save file first to enable chat...',
                              disabled: @swarm_template.visual_data&.dig('file_path').blank?,
                              rows: 2,
                              class: "flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:border-orange-500 dark:focus:border-orange-400 focus:outline-none focus:ring-1 focus:ring-orange-500 dark:focus:ring-orange-400 resize-none #{@swarm_template.visual_data&.dig('file_path').blank? ? 'opacity-50 cursor-not-allowed' : ''}" %>
              
              <%= f.submit nil,
                           disabled: @swarm_template.visual_data&.dig('file_path').blank?,
                           data: { claude_chat_target: "sendButton" },
                           class: "px-4 py-2 text-sm font-medium text-white bg-orange-600 dark:bg-orange-600 rounded-lg hover:bg-orange-700 dark:hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 dark:focus:ring-orange-400 #{@swarm_template.visual_data&.dig('file_path').blank? ? 'opacity-50 cursor-not-allowed' : ''}",
                           value: "➤" %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Hidden file input for import -->
  <input type="file" 
         data-swarm-visual-builder-target="importInput"
         data-action="change->swarm-visual-builder#handleImportFile"
         accept=".yaml,.yml"
         class="hidden">
  
  
  <!-- SVG Icons -->
  <svg class="hidden">
    <symbol id="cube-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
      <path d="M12 2l10 5v10l-10 5-10-5V7z M12 7v10 M2 7l10 5 10-5 M7 19.5V9.5l10 5v10" />
    </symbol>
  </svg>
  
  <!-- Paste YAML Modal -->
  <div data-swarm-visual-builder-target="pasteYamlModal"
       class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      <!-- Background overlay -->
      <div class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity" 
           data-action="click->swarm-visual-builder#closePasteYamlModal"></div>
      
      <!-- Modal panel -->
      <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
        <div class="bg-white dark:bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-orange-100 dark:bg-orange-900 sm:mx-0 sm:h-10 sm:w-10">
              <%= heroicon "document-text", variant: :outline, options: { class: "h-6 w-6 text-orange-600 dark:text-orange-400" } %>
            </div>
            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left flex-1">
              <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-gray-100">
                Paste YAML Configuration
              </h3>
              <div class="mt-4">
                <textarea data-swarm-visual-builder-target="pasteYamlTextarea"
                          placeholder="Paste your YAML content here..."
                          rows="15"
                          class="w-full rounded-md border-0 px-3 py-2 text-gray-900 dark:text-gray-100 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-1 focus:ring-inset focus:ring-gray-300 dark:focus:ring-gray-600 focus:outline-none sm:text-sm sm:leading-6 bg-white dark:bg-gray-700 font-mono text-sm"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
          <button type="button"
                  data-action="click->swarm-visual-builder#importPastedYaml"
                  class="inline-flex w-full justify-center rounded-md bg-orange-600 dark:bg-orange-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-orange-500 dark:hover:bg-orange-500 sm:ml-3 sm:w-auto">
            Import
          </button>
          <button type="button"
                  data-action="click->swarm-visual-builder#closePasteYamlModal"
                  class="mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-100 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:ml-3 sm:w-auto">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<% end %>